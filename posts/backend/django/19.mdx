---
title: "[Django] M:N ëª¨ë¸ë§"

categories:
  - Django

tags:
  - Django

date: 2022-04-18T18:00
last_modified_at: 2022-04-18T18:00
author_profile: true

toc: true
toc_label: "ëª©ì°¨"
toc_icon: "bars"
toc_sticky: true
published: true
---

## ì˜ˆì‹œ

> ë³‘ì› ì§„ë£Œ ê¸°ë¡ ì‹œìŠ¤í…œì„ ì˜ˆì‹œë¡œ, N:M ëª¨ë¸ë§ì„ ì‚´í´ë³´ì

<br />

- í•œ í™˜ìê°€ ì—¬ëŸ¬ ì˜ì‚¬ì—ê²Œ ì§„ë£Œë¥¼ ë°›ê³ , í•œ ì˜ì‚¬ê°€ ì—¬ëŸ¬ í™˜ìë¥¼ ì§„ë£Œí•œë‹¤.
- ì¦‰, í™˜ìì™€ ì˜ì‚¬ì˜ ê´€ê³„ëŠ” ì„œë¡œ ëŒ€ë“±í•˜ë©°, N:Mì˜ ê´€ê³„ì´ë‹¤.

<br />

### ë°©ì‹ A : 1:N ë°©ì‹

> ê¸°ì¡´ì˜ ForeignKey ë°©ì‹ìœ¼ë¡œ modelì„ ì •ì˜í•´ë³´ì.

```python
# hospitals/models.py
from django.db import models

class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'


class Patient(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

<br />

> ì˜ì‚¬ 2ëª…ê³¼ í™˜ì 2ëª… ìƒì„±

```bash
In [1]: doctor1 = Doctor.objects.create(name='justin')

In [2]: doctor2 = Doctor.objects.create(name='eric')

In [3]: patient1 = Patient.objects.create(name='tony', doctor=doctor1)

In [4]: patient2 = Patient.objects.create(name='harry', doctor=doctor2)

In [5]: doctor1
Out[5]: <Doctor: 1ë²ˆ ì˜ì‚¬ justin>

In [6]: doctor2
Out[6]: <Doctor: 2ë²ˆ ì˜ì‚¬ tony>

In [7]: patient1
Out[7]: <Patient: 1ë²ˆ í™˜ì tony>

In [8]: patient2
Out[8]: <Patient: 2ë²ˆ í™˜ì harry>

In [9]: patient3 = Patient.objects.create(name='james', doctor=doctor1, doctor2)

SyntaxError: postitional argument follows keyword argument
```

- í•œ í™˜ì(patient3)ê°€ doctor1, doctor2ì˜ ì—¬ëŸ¬ ì˜ì‚¬ë“¤ì—ê²Œ ì§„ë£Œë¥¼ ë°›ì•„ì•¼ í•œë‹¤.
- í•˜ì§€ë§Œ, ì™¸ë˜í‚¤ëŠ” 2ê°œì˜ ë°ì´í„°ë¥¼ ë„£ì„ ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— ì—ëŸ¬ ë°œìƒ
- **1:Nì˜ í•œê³„!**

<br />

### ë°©ì‹ B : ì¤‘ê°œ ëª¨ë¸

```python
from django.db import models


class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'


# ì™¸ë˜í‚¤ ì‚­ì œ
class Patient(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'

# ì¤‘ê°œëª¨ë¸ ì‘ì„±
class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)

    def __str__(self):
        return f'{self.doctor_id}ë²ˆ ì˜ì‚¬ì˜ {self.patient_id}ë²ˆ í™˜ì'
```

- ê° ëª¨ë¸ì„ 1:N ì°¸ì¡°í•˜ëŠ” Reservation ëª¨ë¸ ìƒì„±
- Patient ëª¨ë¸ì˜ ì™¸ë˜í‚¤ê°€ ì‚¬ë¼ì§€ê³ , Reservation ëª¨ë¸ì˜ ì™¸ë˜í‚¤ê°€ 2ê°œ
- ì¦‰, ê° ëª¨ë¸ì„ 1ë¡œ í•˜ê³ , ìì‹ ì€ Nìœ¼ë¡œ í•˜ì—¬ ì˜ˆì•½ê³¼ ê´€ë ¨ëœ ì •ë³´ë“¤ì„ ëª¨ë‘ ëª¨ìœ¼ëŠ” ì¤‘ê°œ ëª¨ë¸ Reservation

migration ì‹¤ì‹œ


<br />

ì¤‘ê°œ í…Œì´ë¸”ì„ í†µí•œ ì˜ˆì•½

```bash
# ì˜ì‚¬ì™€ í™˜ìê°€ ê°ê° ìƒì„±
In [1]: doctor1 = Doctor.objects.create(name='justin')

In [2]: patient1 = Patient.objects.create(name='tony')

# ì¤‘ê°œ í…Œì´ë¸”ì— ì˜ˆì•½ ë ˆì½”ë“œ ì¶”ê°€
In [3]: Reservation.objects.create(doctor=doctor1, patient=patient1)
Out[3]: <Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 1ë²ˆ í™˜ì>


# ì˜ì‚¬ì™€ í™˜ì ê°ê°ì— ëŒ€í•œ ì—­ì°¸ì¡°
In [4]: doctor1.reservation_set.all()
Out[4]: <QuerySet [<Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 1ë²ˆ í™˜ì>]>

In [5]: patient1.reservation_set.all()
Out[5]: <QuerySet [<Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 1ë²ˆ í™˜ì>]>


# ìƒˆ í™˜ì ìƒì„± ë° ì˜ˆì•½ ì¶”ê°€
In [6]: patient2 = Patient.objects.create(name='harry')

In [7]: Reservation.objects.create(doctor=doctor1, patient=patient2)
Out[7]: <Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 2ë²ˆ í™˜ì>


# ì˜ì‚¬ì™€ í™˜ì ê°ê°ì— ëŒ€í•œ ì—­ì°¸ì¡°
In [8]: doctor1.reservation_set.all()
Out[8]: <QuerySet [<Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 1ë²ˆ í™˜ì>, <Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 2ë²ˆ 
í™˜ì>]>

In [9]: patient2.reservation_set.all()
Out[9]: <QuerySet [<Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 2ë²ˆ í™˜ì>]>
```

<br />

### ë°©ì‹ C : ManyToManyField

- ë‹¤ëŒ€ë‹¤ ê´€ê³„(M:N) ì„¤ì • ì‹œ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ í•„ë“œ
- í•˜ë‚˜ì˜ í•„ìˆ˜ ìœ„ì¹˜ì¸ì(M:N ê´€ë¡€ë¡œ ì„¤ì •í•  ëª¨ë¸ í´ë˜ìŠ¤) í•„ìš”
- ì‘ì„± ìœ„ì¹˜ëŠ” Doctor ë˜ëŠ” Patient ëª¨ë‘ ì‘ì„± ê°€ëŠ¥

<br />

```python
# hospital/models.py
from django.db import models


class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'


class Patient(models.Model):
    # ManyToManyField ì‘ì„±
    doctors = models.ManyToManyField(Doctor)
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

<br />

> ë¬´ìŠ¨ ì°¨ì´ê°€ ìƒê¸´ê±°ì£ ?

- ì¤‘ê°œ ëª¨ë¸(Reservation)ì´ ì‚­ì œ
- ManyToManyFieldê°€ í™˜ì ìª½ì— ì‘ì„±
- Mê³¼ N ê·¸ ìì²´ì—ëŠ” ì°¨ì´ê°€ ì—†ë‹¤. ForeignKeyë„ ì—†ë‹¤. **Field í•˜ë‚˜ê°€ ì¤‘ê°œ í…Œì´ë¸” í•˜ë‚˜ë¥¼ ë§Œë“ ë‹¤!**

<br />

> ManyToManyFieldê°€ Doctorì— ìˆìœ¼ë©´ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?

- 1:Nì€ ì¢…ì† ê´€ê³„ì´ê¸° ë•Œë¬¸ì— ForeignKey FieldëŠ” í™•ì‹¤íˆ Nìª½ì— ìˆì–´ì•¼ í•œë‹¤.
- M:Nì€ ëŒ€ë“±í•œ ê´€ê³„ì´ê¸° ë•Œë¬¸ì— ê´œì°®ë‹¤.
- Mê³¼ N ìì²´ì˜ ë³€í™”ëŠ” ì—†ë‹¤.
- í…Œì´ë¸” ì´ë¦„ì´ ë°”ë€” ê²ƒì´ë‹¤. í•˜ì§€ë§Œ ì˜ë¯¸ëŠ” ì—†ë‹¤.
- ë‹¤ë§Œ **ì°¸ì¡°ì™€ ì—­ì°¸ì¡°ì˜ ì…ì¥ì´ ë°”ë€Œê¸´ í•  ê²ƒ**
  - ManyToMany Fieldê°€ ìˆëŠ” modelì´ ìƒëŒ€ modelì„ ì°¸ì¡°, ë°˜ëŒ€ëŠ” ì—­ì°¸ì¡°
  - 1:Nì—ì„œë„ ForeignKeyê°€ ìˆëŠ” ìª½ì´ ì—†ëŠ” ìª½ì„ ì°¸ì¡°, ë°˜ëŒ€ëŠ” ì—­ì°¸ì¡°

<br />

```bash
# ì˜ì‚¬ì™€ í™˜ì ì •ë³´ ìƒì„±
In [1]: doctor1 = Doctor.objects.create(name='justin')

In [2]: patient1 = Patient.objects.create(name='tony')

In [3]: patient2 = Patient.objects.create(name='harry')


# 1ë²ˆ í™˜ì ì…ì¥ì—ì„œ 1ë²ˆ ì˜ì‚¬ ì¶”ê°€
In [4]: patient1.doctors.add(doctor1)

# 1ë²ˆ í™˜ì ì…ì¥ì—ì„œ ì˜ì‚¬ í™•ì¸(ì°¸ì¡°)
In [5]: patient1.doctors.all()
Out[5]: <QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ justin>]>

# 1ë²ˆ ì˜ì‚¬ ì…ì¥ì—ì„œ í™˜ì í™•ì¸(ì—­ì°¸ì¡°)
In [6]: doctor1.patient_set.all()
Out[6]: <QuerySet [<Patient: 1ë²ˆ í™˜ì tony>]>


# 1ë²ˆ ì˜ì‚¬ ì…ì¥ì—ì„œ 2ë²ˆ í™˜ì ì¶”ê°€
In [7]: doctor1.patient_set.add(patient2)

In [8]: doctor1.patient_set.all()
Out[8]: <QuerySet [<Patient: 1ë²ˆ í™˜ì tony>, <Patient: 2ë²ˆ í™˜ì harry>]>

In [9]: patient2.doctors.all()
Out[9]: <QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ justin>]>

In [10]: patient1.doctors.all()
Out[10]: <QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ justin>]>


# 1ë²ˆ ì˜ì‚¬ê°€ 1ë²ˆ í™˜ìì— ëŒ€í•œ ì˜ˆì•½ ì·¨ì†Œ
In [11]: doctor1.patient_set.remove(patient1)

In [12]: doctor1.patient_set.all()
Out[12]: <QuerySet [<Patient: 2ë²ˆ í™˜ì harry>]>

In [13]: patient1.doctors.all()
Out[13]: <QuerySet []>

# 2ë²ˆ í™˜ìê°€ 1ë²ˆ ì˜ì‚¬ì— ëŒ€í•œ ì˜ˆì•½ ì·¨ì†Œ
In [15]: patient2.doctors.remove(doctor1)

In [16]: patient2.doctors.all()
Out[16]: <QuerySet []>

In [17]: doctor1.patient_set.all()
Out[17]: <QuerySet []>
```

- ì–´ëŠ ì…ì¥ì—ì„œ ì¤‘ê°œ í…Œì´ë¸”ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•´ë„ ìƒê´€ì´ ì—†ë‹¤.
- add, remove() ë“± setì—ì„œ ì‚¬ìš©ë˜ëŠ” ë©”ì†Œë“œ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥

<br />

### releated_name ì‚¬ìš©

> doctor_set, patient_set ë¶ˆí¸í•©ë‹ˆë‹¤!

- **releated_nameì„ í™œìš©**í•œë‹¤.
- 1:Nì—ì„œ ì§€ì–‘í–ˆë˜ ì´ìœ ëŠ” M:Nì—ì„œ í™œìš©í•˜ê¸° ìœ„í•¨ì´ì—ˆìŒ
- 1:Nê³¼ M:Nì„ êµ¬ë¶„í•˜ëŠ” í° ì§€í‘œ

<br />

- **target model**(ê´€ê³„ í•„ë“œë¥¼ ê°€ì§€ì§€ ì•Šì€ ëª¨ë¸; Doctor)ì´ **source model**(ê´€ê³„ í•„ë“œë¥¼ ê°€ì§„ ëª¨ë¸; í™˜ì)ì„ ì°¸ì¡°, ì¦‰ **ì—­ì°¸ì¡°í•  ë•Œ ì‚¬ìš©í•  managerì˜ ì´ë¦„ì„ ì„¤ì •**

- patients, doctors ì²˜ëŸ¼ **ë³µìˆ˜í˜•ìœ¼ë¡œ ì‚¬ìš©**

<br />

```python
from django.db import models


class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'


class Patient(models.Model):
    # ManyToManyField - related_name ì‘ì„±
    doctors = models.ManyToManyField(Doctor, related_name='patients') ğŸ”…
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'
```

<br />

```bash
In [1]: doctor1 = Doctor.objects.get(pk=1)

In [2]: doctor1
Out[2]: <Doctor: 1ë²ˆ ì˜ì‚¬ justin>

In [3]: doctor1.patient_set.all()
AttributeError: 'Doctor' object has no attribute 'patient_set'

In [4]: doctor1.patients.all()
Out[4]: <QuerySet []>
```

- ê¸°ë³¸ì ìœ¼ë¡œ ì‚¬ìš©í•˜ë˜ ì—­ì°¸ì¡° managerì¸ patient_setì€ ì‚¬ìš© ë¶ˆê°€
- related_nameì¸ 'patients'ë¥¼ ì‚¬ìš©

<br />

### django M:Nì—ì„œ ì¤‘ê°œ í…Œì´ë¸” ì‘ì„±

- djangoëŠ” ManyToManyFieldë¥¼ í†µí•´ ì¤‘ê°œ í…Œì´ë¸”ì„ ìë™ ìƒì„±

<br />

> ì¤‘ê°œ í…Œì´ë¸”ì„ ì§ì ‘ ì‘ì„±í•  ìˆ˜ëŠ” ì—†ì„ê¹Œ?

- **through ì˜µì…˜** ì‚¬ìš©
- ì¤‘ê°œ í…Œì´ë¸”ì— **ì¶”ê°€ ë°ì´í„°ë¥¼ ì‚¬ìš©**í•˜ëŠ” ê²½ìš° ì‚¬ìš©

<br />

## ManyToManyField

- ë‹¤ëŒ€ë‹¤(M:N, many-to-many) ê´€ê³„ ì„¤ì • ì‹œ ì‚¬ìš©í•˜ëŠ” ëª¨ë¸ í•„ë“œ
- í•˜ë‚˜ì˜ í•„ìˆ˜ ìœ„ì¹˜ì¸ì(M:N ê´€ê³„ë¡œ ì„¤ì •í•  ëª¨ë¸ í´ë˜ìŠ¤) í•„ìš”
- ëª¨ë¸ í•„ë“œì˜ RelatedManagerë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ë ¨ ê°œì²´ë¥¼ ì¶”ê°€(add), ì œê±°(remove) ê°€ëŠ¥

<br />

### Arguments

> related_name

- ì—­ì°¸ì¡°ì‹œ ì‚¬ìš©í•  managerì˜ ì´ë¦„ ì„¤ì •
- ForeignKeyì˜ related_nameê³¼ ë™ì¼

<br />

> through

- ì¤‘ê°œ í…Œì´ë¸”ì„ ì§ì ‘ ì‘ì„±í•˜ëŠ” ê²½ìš°, ì¤‘ê°œ í…Œì´ë¸”ì„ ë‚˜íƒ€ë‚´ëŠ” Django ëª¨ë¸ì„ ì§€ì • ê°€ëŠ¥
- ì¤‘ê°œ í…Œì´ë¸”ì— ì¶”ê°€ ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ë‹¤ëŒ€ë‹¤ ê´€ê³„ì™€ ì—°ê²°í•˜ëŠ” ê²½ìš° ì‚¬ìš©

<br />

> symmetrical

- ì—°ê²°ëœ ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¼ë¦¬ì˜ ì°¸ì¡°ë¥¼ ë™ê¸°í™”í•˜ëŠ” ê²ƒ
- ê¸°ë³¸ê°’ì€ True (ë™ê¸°í™”ë¥¼ í•œë‹¤ëŠ” ê²ƒ)
- í›„ìˆ 

<br />

### Related Manager

- 1:N ë˜ëŠ” M:N ê´€ë ¨ contextì—ì„œ ì‚¬ìš©ë˜ëŠ” manager
- ê°™ì€ ì´ë¦„ì˜ ë©”ì„œë“œì—¬ë„ ê° ê´€ê³„ì— ë”°ë¼ ë‹¤ë¥´ê²Œ ì‚¬ìš© ë° ë™ì‘
  - 1:N : **target ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë§Œ ì‚¬ìš© ê°€ëŠ¥**
  - M:N : **ë‘ ê°ì²´ ëª¨ë‘ ì‚¬ìš© ê°€ëŠ¥**
- add(), remove(), create(), clear(), set() ë“±ì´ ìˆìŒ

<br />

> add()

- ì§€ì •ëœ ê°ì²´ë¥¼ ê´€ë ¨ ê°ì²´ ì§‘í•©ì— ì¶”ê°€
- **ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê´€ê³„ì— ì‚¬ìš© ì‹œ ë³µì œ X**
- ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤, í•„ë“œ ê°’(PK)ì„ ì¸ìë¡œ í—ˆìš©

<br />

> remove()

- ê´€ë ¨ ê°ì²´ ì§‘í•©ì—ì„œ ì§€ì •ëœ ëª¨ë¸ ê°ì²´ ì œê±°
- ë‚´ë¶€ì ìœ¼ë¡œ **QuerySet.delete()**ë¥¼ ì‚¬ìš©í•˜ì—¬ ê´€ê³„ ì‚­ì œ
- ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤, í•„ë“œ ê°’(PK)ì„ ì¸ìë¡œ í—ˆìš©

<br />

### through

```python
from django.db import models


class Doctor(models.Model):
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ ì˜ì‚¬ {self.name}'


class Patient(models.Model):
    doctors = models.ManyToManyField(Doctor, through='Reservation') ğŸ”…
    name = models.TextField()

    def __str__(self):
        return f'{self.pk}ë²ˆ í™˜ì {self.name}'


class Reservation(models.Model):
    doctor = models.ForeignKey(Doctor, on_delete=models.CASCADE)
    patient = models.ForeignKey(Patient, on_delete=models.CASCADE)
    symptom = models.TextField() ğŸ”…
    reserved_at = models.DateTimeField(auto_now_add=True) ğŸ”…

    def __str__(self):
        return f'{self.doctor.pk}ë²ˆ ì˜ì‚¬ì˜ {self.patient.pk}ë²ˆ í™˜ì'
```

- modelë“¤ì— ì •ì˜ëœ ì†ì„±ë“¤ ì™¸ì˜ ****ì¶”ê°€ í•„ë“œë¥¼ ì‚¬ìš©í•˜ê³  ì‹¶ì€ ê²½ìš°**
- symptom(ì¦ìƒ), reserved_at(ì˜ˆì•½ ì‹œê°„) í•„ë“œë¥¼ ì¶”ê°€

<br />

```bash
# ì˜ì‚¬ ë° í™˜ì ì •ë³´ ìƒì„± ë° ì €ì¥
In [1]: doctor1 = Doctor.objects.create(name='justin')

In [2]: patient1 = Patient.objects.create(name='tony')

In [3]: patient2 = Patient.objects.create(name='harry')


# reservation ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
In [4]: reservation1 = Reservation(doctor=doctor1, patient=patient1, symptom='headache') ğŸ”…

In [5]: reservation1
Out[5]: <Reservation: 1ë²ˆ ì˜ì‚¬ì˜ 1ë²ˆ í™˜ì>

# reservation ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
In [6]: reservation1.save()

# ì˜ˆì•½ í™•ì¸
In [7]: doctor1.patient_set.all()
Out[7]: <QuerySet [<Patient: 1ë²ˆ í™˜ì tony>]>

In [8]: patient1.doctors.all()
Out[8]: <QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ justin>]>


# í™˜ìì— ì˜í•œ ì˜ˆì•½ ì¶”ê°€
In [9]: patient2.doctors.add(doctor1, through_defaults={'symptom': 'flu'}) â­

In [10]: doctor1.patient_set.all()
Out[10]: <QuerySet [<Patient: 1ë²ˆ í™˜ì tony>, <Patient: 2ë²ˆ í™˜ì harry>]>

In [11]: patient2.doctors.all()
Out[11]: <QuerySet [<Doctor: 1ë²ˆ ì˜ì‚¬ justin>]>
```

- through_defaults ì˜µì…˜

<br />

### ì¤‘ê°œ í…Œì´ë¸”ì˜ í•„ë“œ ìƒì„± ê·œì¹™

> source model ë° target model ëª¨ë¸ì´ ë‹¤ë¥¸ ê²½ìš°

- id
- `<containing_model>_id`
- `<other_model>_id`

<br />

> ManyToManyFieldê°€ ë™ì¼í•œ ëª¨ë¸ì„ ê°€ë¦¬í‚¤ëŠ” ê²½ìš°

- id
- `from_<model>_id`
- `to_<model>_id`

<br />

## Like ê¸°ëŠ¥

```python
from django.db import models
from django.conf import settings

# Create your models here.
class Article(models.Model):
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    like_users = models.ManyToManyField(settings.AUTH_USER_MODEL, related_name='like_articles') â­
    title = models.CharField(max_length=10)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.title


class Comment(models.Model):
    article = models.ForeignKey(Article, on_delete=models.CASCADE)
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE)
    content = models.CharField(max_length=200)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return self.content
```

- like_users í•„ë“œ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ ì—­ì°¸ì¡°ëŠ” .article_set ë§¤ë‹ˆì €ë¥¼ ìƒì„±
- ì´ì „ 1:N(User:Article) ê´€ê³„ì—ì„œ **ì´ë¯¸ í•´ë‹¹ ë§¤ë‹ˆì €ë¥¼ ì‚¬ìš©ì¤‘ì´ì–´ì„œ migration ì—ëŸ¬**
- Userì™€ ê´€ê³„ëœ ForeignKey ë˜ëŠ” ManyToManyField ì¤‘ í•˜ë‚˜ì— **related_name ì¶”ê°€** í•„ìš”
- 'like_articles'ë¡œ ì´ë¦„ ì¬ì§€ì •

<br />

### í˜„ì¬ User-Articleê°„ ì‚¬ìš© ê°€ëŠ¥í•œ DB API

> article.user

ê²Œì‹œê¸€ì„ ì‘ì„±í•œ ìœ ì € - 1:N

<br />

> article.like_users

ê²Œì‹œê¸€ì„ ì¢‹ì•„ìš”í•œ ìœ ì € - M:N

<br />

> user.article_set

ìœ ì €ê°€ ì‘ì„±í•œ ê²Œì‹œê¸€(ì—­ì°¸ì¡°) - 1:N

<br />

> users.like_articles

ìœ ì €ê°€ ì¢‹ì•„ìš”í•œ ê²Œì‹œê¸€(ì—­ì°¸ì¡°) - M:N

<br />

<br />

```python
# articles/urls.py
from django.urls import path
from . import views


app_name = 'articles'
urlpatterns = [
    path('', views.index, name='index'),
    path('create/', views.create, name='create'),
    path('<int:pk>/', views.detail, name='detail'),
    path('<int:pk>/delete/', views.delete, name='delete'),
    path('<int:pk>/update/', views.update, name='update'),
    path('<int:pk>/comments/', views.comment_create, name='comment_create'),
    path('<int:article_pk>/comments/<int:comment_pk>/delete/', views.comment_delete, name='comment_delete'),
    path('<int:article_pk>/likes/', views.likes, name='likes'), ğŸ”…
]
```

<br />

> ì¢‹ì•„ìš”ë¥¼ ëˆŒë €ë‹¤ë©´ ì¢‹ì•„ìš” ì·¨ì†Œ, ì•„ë‹ˆë¼ë©´ ì¢‹ì•„ìš”

> ê°€. ì¢‹ì•„ìš”/ì·¨ì†Œ ê¸°ëŠ¥ì— ì¶©ì‹¤í•œ ì½”ë“œ

```python
# articles/views.py
def likes(request, article_pk):
    article = get_object_or_404(Article, pk=article_pk)
    
    # ì´ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìœ ì € ëª©ë¡ì— í˜„ì¬ ìš”ì²­í•œ ìœ ì €ê°€ ìˆë‹¤ë©´, ì¢‹ì•„ìš” ì·¨ì†Œ
    if request.user in article.like_users.all():
        article.like_users.remove(request.user)
    
    # ì´ì „ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš°
    else:
        article.like_users.add(request.user)
    return redirect('articles:index')
```

- variable routingì„ í†µí•´ ì „ë‹¬ë°›ì€ article_pkë¥¼ ì´ìš©í•´ article ì¡°íšŒ
- articleì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ userë“¤ queryset ì¤‘ì— request.userê°€ ìˆëŠ”ì§€ í™•ì¸
- ìˆë‹¤ë©´ ì¢‹ì•„ìš” ì·¨ì†Œì´ë¯€ë¡œ articleì˜ like_users querysetì—ì„œ request.user ì œê±°(remove)
- ì•„ë‹ˆë¼ë©´ articleì˜ like_users querysetì— request.user ì¶”ê°€(add)

<br />

```html
{%- raw -%}
{% extends 'base.html' %}

{% block content %}
  <h1>Articles</h1>
  {% if request.user.is_authenticated %}
    <a href="{% url 'articles:create' %}">CREATE</a>
  {% else %}
    <a href="{% url 'accounts:login' %}">[ìƒˆ ê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ ë¡œê·¸ì¸ í•˜ì„¸ìš”]</a>
  {% endif %}
  <hr>
  {% for article in articles %}
    <p>ì‘ì„±ì: {{ article.user }}</p>
    <p>ê¸€ ë²ˆí˜¸: {{ article.pk }}</p>  
    <p>ê¸€ ì œëª©: {{ article.title }}</p>
    <p>ê¸€ ë‚´ìš©: {{ article.content }}</p>
    <div>
      <form action="{% url 'articles:likes' article.pk %}" method="POST"> ğŸ”…
        {% csrf_token %}
        <input type="submit" value="ì¢‹ì•„ìš”"> ğŸ”…
      </form>
    </div>
    <a href="{% url 'articles:detail' article.pk %}">DETAIL</a>
    <hr>
  {% endfor %}
{% endblock content %}
{% endraw -%}
```

ì¢‹ì•„ìš” ë²„íŠ¼ form ì¶”ê°€

<br />

> ë¬¸ì œì  ë°œê²¬

`![image](https://user-images.githubusercontent.com/86189596/163759343-5b41bd5f-79ae-4e16-b465-bb992324ff11.png)`

- Article ìƒì„±ì— ì‚¬ìš©ëœ ArticleFormì— like_users ì¶”ê°€
- modelì„ Articleì„ ì°¸ì¡°í•˜ëŠ”ë°, Articleì— like_usersê°€ ì •ì˜ë˜ì—ˆê¸° ë•Œë¬¸
- ì´ë¥¼ ì¡°ì •í•´ë³´ì.

<br />

> ArticleForm ìˆ˜ì •

```python
# articles/forms.py
from django import forms
from .models import Article, Comment

class ArticleForm(forms.ModelForm):

    class Meta:
        model = Article
        exclude = ('user', 'like_users',) ğŸ”…
```

excludeì— like_usersë¥¼ ì¶”ê°€í•´ renderingì—ì„œ ì œì™¸í•œë‹¤.

<br />

> ì¢‹ì•„ìš” ì·¨ì†Œ ê¸°ëŠ¥ ì¶”ê°€

```html
{%- raw -%}
<!-- articles/index.html -->
...
<form action="{% url 'articles:likes' article.pk %}" method="POST">
  {% csrf_token %}
  {% if user in article.like_users.all %}
    <input type="submit" value="ì¢‹ì•„ìš” ì·¨ì†Œ">
  {% else %}
    <input type="submit" value="ì¢‹ì•„ìš”">
  {% endif %}
</form>
{% endraw -%}
```

- article.like_users.all queryset APIë¥¼ ì´ìš©
- templateì—ì„œ if elseë¬¸ ì‚¬ìš©ìœ¼ë¡œ ë²„íŠ¼ì˜ value í‘œì‹œ ë‹¤ë¥´ê²Œ í•˜ê¸°

<br />

### QuerySet API : exist()

- QuerySetì— ê²°ê³¼ê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ True ë°˜í™˜, ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ False ë°˜í™˜
- ê·œëª¨ê°€ í° QuerySetì˜ ì»¨í…ìŠ¤íŠ¸ì—ì„œ íŠ¹ì • ê°œì²´ ì¡´ì¬ ì—¬ë¶€ì™€ ê´€ë ¨ëœ ê²€ìƒ‰ì— ìœ ìš©
- ê³ ìœ í•œ í•„ë“œ(ex. primary key)ê°€ ìˆëŠ” ëª¨ë¸ì´ QuerySetì˜ êµ¬ì„±ì›ì¸ì§€ ì—¬ë¶€ë¥¼ ì°¾ëŠ” ê°€ì¥ íš¨ìœ¨ì ì¸ ë°©ë²•

<br />

> ìœ„ì˜ vieww í•¨ìˆ˜ë¥¼ exist()ë¥¼ í™œìš©í•´ ê°œì„ í•´ë³´ì

```python
# articles/views.py
def likes(request, article_pk):
    article = get_object_or_404(Article, pk=article_pk)
    
    # ì´ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìœ ì € ëª©ë¡ì— í˜„ì¬ ìš”ì²­í•œ ìœ ì €ê°€ ìˆë‹¤ë©´, ì¢‹ì•„ìš” ì·¨ì†Œ
    # if request.user in article.like_users.all():
    if article.like_users.filter(pk=request.user.pk).exists(): ğŸ”…
        article.like_users.remove(request.user)
    
    # ì´ì „ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš°
    else:
        article.like_users.add(request.user)
    return render('articles/index.html')
```

<br />

## Profile Page

> urls

```python
# accounts/urls.py
from django.urls import path
from . import views

app_name = 'accounts'
urlpatterns = [
    ...
    # â­ ë¬¸ìì—´ë¡œ ì‹œì‘í•˜ëŠ” variable routingì´ë¯€ë¡œ ìœ„ì¹˜ì— ì‹ ê²½ ì“°ê¸°
    path('<username>/', views.profile, name='profile'),
]
```

- string variable routingìœ¼ë¡œ ê° ìœ ì €ì— ëŒ€í•œ profile í˜ì´ì§€ url ì •ì˜

<br />

> views

```python
# accounts/views.py
from django.contrib.auth import get_user_model

def profile(request, username):
    person = get_object_or_404(get_user_model(), username=username)
    context = {
        'person': person,
    }
    return render(request, 'accounts/profile.html', context)
```

- userì˜ ì´ë¦„ì„ variable routingìœ¼ë¡œ ë°›ì•„ í•¨ìˆ˜ ë‚´ë¡œ ì „ë‹¬
- ì´ usernameì„ ì´ìš©í•´ DBì—ì„œ íŠ¹ì • userë¥¼ ì°¾ì•„ personì— ì €ì¥

<br />

> templates

```html
{%- raw -%}
<!-- accounts/profile.html -->
{% extends 'base.html' %}

{% block content %}
  <h1>{{ person.username }}ë‹˜ì˜ í”„ë¡œí•„</h1>
  <hr>

  {% comment %} ì´ ì‚¬ëŒì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡ {% endcomment %}
  <h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡</h2>

  {% for article in person.article_set.all %}
    <p>{{ article.title }}</p>
  {% endfor %}

  {% comment %} ì´ ì‚¬ëŒì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëŒ“ê¸€ ëª©ë¡ {% endcomment %}
  <h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëŒ“ê¸€ ëª©ë¡</h2>
  {% for comment in person.comment_set.all %}
    <p>{{ comment.content }}</p>
  {% endfor %}

  {% comment %} ì´ ì‚¬ëŒì´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²Œì‹œê¸€ ëª©ë¡ {% endcomment %}
  <h2>{{ person.username }}ë‹˜ì´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²Œì‹œê¸€ ëª©ë¡</h2>

  {% for article in person.like_articles.all %}
    <p>{{ article.title }}</p>
  {% endfor %}

{% endblock content %}
{% endraw -%}
```

- personì´ ê°€ì§€ê³  ìˆëŠ” article_set, comment_set, like_articles querysetì—ì„œ ê°ê°ì˜ article, comment, article ë“¤ì„ ì¶”ì¶œ

<br />

## Follow

Userì™€ Userê°„ ì°¸ì¡°ì´ê¸° ë•Œë¬¸ì— **ManyToManyFieldì— selfë¥¼ ì°¸ì¡°**

```python
# accounts/models.py
from django.db import models
from django.contrib.auth.models import AbstractUser

# Create your models here.
class User(AbstractUser):
    followings = models.ManyToManyField('self', symmetrical=False, related_name='followers')
```

<br />

### symmetrical

- ManyToManyFieldê°€ ë™ì¼í•œ ëª¨ë¸(on self)ì„ ê°€ë¦¬í‚¤ëŠ” ì •ì˜ì—ì„œë§Œ ì‚¬ìš©
- symmetrical=True(ê¸°ë³¸ê°’)ì¼ ê²½ìš° DjangoëŠ” person_set ë§¤ë‹ˆì €ë¥¼ ì¶”ê°€í•˜ì§€ ì•ŠìŒ
- í•œ ìª½ì—ì„œ ì¶”ê°€ë˜ë©´ ìƒëŒ€ì ì¸ ìª½ë„ ì¶”ê°€ë˜ë¯€ë¡œ ì—­ì°¸ì¡°ê°€ í•„ìš”ê°€ ì—†ì–´ì§„ë‹¤.

- source ëª¨ë¸ì˜ ì¸ìŠ¤í„´ìŠ¤ê°€ target ëª¨ë¸ì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì°¸ì¡°í•˜ë©´, target ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë„ source ëª¨ë¸ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìë™ìœ¼ë¡œ ì°¸ì¡°í•˜ë„ë¡ í•¨

- ë‚´ê°€ ë‹¹ì‹ ì˜ ì¹œêµ¬ë¼ë©´, ë‹¹ì‹ ë„ ë‚´ ì¹œêµ¬ê°€ ë˜ëŠ” ê²ƒ
- ëŒ€ì¹­ì„ ì›ì¹˜ ì•ŠëŠ”ë‹¤ë©´ symmetrical ì˜µì…˜ì„ Falseë¡œ ì„¤ì •

<br />

> migration ê²°ê³¼

`![image](https://user-images.githubusercontent.com/86189596/163763884-0d3b978a-6dc6-428b-9a9c-f5dc7b989e9f.png)`

ìê¸° ìì‹ ì„ ì°¸ì¡°í•  ë•Œì—ëŠ” í•„ë“œëª…ì„ fromê³¼ toë¡œ ì§€ì •

<br />

> urls

```python
# accounts/urls.py
from django.urls import path
from . import views

app_name = 'accounts'
urlpatterns = [
    ...
    path('<int:user_pk>/follow/', views.follow, name='follow'),
]
```

<br />

> views : follow/unfollow ê¸°ëŠ¥

```python
# accounts/views.py
def follow(request, user_pk):
    # personì€ ìƒëŒ€ë°©
    you = get_object_or_404(get_user_model(), pk=user_pk)
    me = request.user
    
    # unfollow
    if me in you.followers.all():
        you.followers.remove(me)
        
    else:
        you.followers.add(me)
    return redirect('accounts:profile', you.username)
```

<br />

> templates

```html
{%- raw -%}
<!-- accounts/profile.py -->
...
<div>
  <form action="accounts:follow" person.pk method="POST">
    {% csrf_token %}
    {% if user in person.followers.all %}
      <input type="submit" value="ì–¸íŒ”ë¡œìš°">
    {% else %}
      <input type="submit" value="íŒ”ë¡œìš°">
    {% endif %}
  </form>
</div>
...
{% endraw -%}
```

<br />

> ê²°ê³¼

`![image](https://user-images.githubusercontent.com/86189596/163765066-3b4374d0-ecfd-4ef8-a0f8-f5bf3311439c.png)`

<br />

> ì½”ë“œ ê°œì„  : ë‚´ê°€ ë‚˜ë¥¼ íŒ”ë¡œìš°í•˜ì§€ ëª»í•˜ê²Œ!

```html
{%- raw -%}
<!-- accounts/profile.py -->
...
<div>
  {% if user != person %} ğŸ”…
    <form action="accounts:follow" person.pk method="POST">
      {% csrf_token %}
      {% if user in person.followers.all %}
        <input type="submit" value="ì–¸íŒ”ë¡œìš°">
      {% else %}
        <input type="submit" value="íŒ”ë¡œìš°">
      {% endif %}
    </form>
  {% endif %}
</div>
...
{% endraw -%}
```

- ë‚´êº¼ëŠ” íŒ”ë¡œìš° ëª»í•˜ë„ë¡, user(request.user)ê°€ person(ëŒ€ìƒ user)ì´ ì•„ë‹Œ ê²½ìš°ì—ë§Œ íŒ”ë¡œìš°/ì–¸íŒ”ë¡œìš° formì´ ë³´ì´ë„ë¡ í•œë‹¤.

<br />

### ìµœì¢… ì½”ë“œ

> likes view í•¨ìˆ˜

```python
# articles/views.py
@require_POST
def likes(request, article_pk):
    if request.user.is_authenticated:
        article = get_object_or_404(Article, pk=article_pk)
        
        # ì´ ê²Œì‹œê¸€ì˜ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ìœ ì € ëª©ë¡ì— í˜„ì¬ ìš”ì²­í•œ ìœ ì €ê°€ ìˆë‹¤ë©´, ì¢‹ì•„ìš” ì·¨ì†Œ
        # if request.user in article.like_users.all():
        if article.like_users.filter(pk=request.user.pk).exists():
            article.like_users.remove(request.user)
        
        # ì´ì „ì— ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥´ì§€ ì•Šì€ ê²½ìš°
        else:
            article.like_users.add(request.user)
        return redirect('articles:index')
    return redirect('accounts:login')
```

<br />

> follow view í•¨ìˆ˜

```python
# accounts/views.py
@require_POST
def follow(request, user_pk):
    if request.user.is_authenticated:
        you = get_object_or_404(get_user_model(), pk=user_pk)
        me = request.user
        
        if me != you:
            # unfollow
            # if me in you.followers.all():
            if you.followers.filter(pk=me.pk).exists():
                you.followers.remove(me)
            else:
                you.followers.add(me)
        return redirect('accounts:profile', you.username)
    return redirect('accounts:login')
```

<br />

> profile html ì½”ë“œ

```html
{%- raw -%}
<!-- accounts/profile.py -->
<h1>{{ person.username }}ë‹˜ì˜ í”„ë¡œí•„</h1>

<hr>
<div>íŒ”ë¡œì›Œ : {{ person.followers.all|length }} / íŒ”ë¡œìš° : {{ person.followings.all|length }}</div> ğŸ”…

<div>
  {% if user != person %}
    <form action="{% url 'accounts:follow' person.pk %}" method="POST">
      {% csrf_token %}
      {% if user in person.followers.all %}
        <input type="submit" value="ì–¸íŒ”ë¡œìš°">
      {% else %}
        <input type="submit" value="íŒ”ë¡œìš°">
      {% endif %}
    </form>
  {% endif %}
</div>

{% comment %} ì´ ì‚¬ëŒì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡ {% endcomment %}
<h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëª©ë¡</h2>

{% for article in person.article_set.all %}
  <p>{{ article.title }}</p>
{% endfor %}

{% comment %} ì´ ì‚¬ëŒì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëŒ“ê¸€ ëª©ë¡ {% endcomment %}
<h2>{{ person.username }}ë‹˜ì´ ì‘ì„±í•œ ê²Œì‹œê¸€ ëŒ“ê¸€ ëª©ë¡</h2>
{% for comment in person.comment_set.all %}
  <p>{{ comment.content }}</p>
{% endfor %}

{% comment %} ì´ ì‚¬ëŒì´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²Œì‹œê¸€ ëª©ë¡ {% endcomment %}
<h2>{{ person.username }}ë‹˜ì´ ì¢‹ì•„ìš”ë¥¼ ëˆ„ë¥¸ ê²Œì‹œê¸€ ëª©ë¡</h2>

{% for article in person.like_articles.all %}
  <p>{{ article.title }}</p>
{% endfor %}
{% endraw -%}
```